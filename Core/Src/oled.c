/*
 * oled.c
 *
 *  Created on: Jun 20, 2025
 *      Author: ACER
 */
#include "main.h"
#include "oled.h"
#include "servo.h"

uint8_t open[4][128] = {
	{ 	/* page 0 */
		0b00000000, 0b00000000, 0b11110000, 0b11111000, 0b00011100, 0b00001100, 0b00001100, 0b00011000, 0b01110000, 0b11000000, // l
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  			// ' '
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	// o
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // p
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // e
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // n
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // e
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000	// d
	},
	{	/* page 1 */
		0b00000000, 0b00000000, 0b11111111, 0b11111111, 0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b01110000, 0b00011111, // l
		0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111110, 0b11111110, 0b00000000, 0b00000000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	// i
		0b00000000, 0b11000000, 0b01100000, 0b00100000, 0b11100000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,				// ' '
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// o
		0b00000000, 0b00000000, 0b10000000, 0b11000000, 0b11000000, 0b11000000, 0b11000000, 0b10000000, 0b00000000,	0b00000000,	// p
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// e
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// n
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// e
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111110, 0b11111110, 0b00000000, 0b00000000	// d
	},
	{	/* page 2 */
		0b11000000, 0b01100000, 0b11111111, 0b11111111, 0b00001100, 0b00000110, 0b00000011, 0b00000001, 0b00000000, 0b00000000, // l
		0b00000000, 0b00000000, 0b10000000, 0b11111100, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b11111000, 0b11111100, 0b00001100, 0b00001100, 0b00001100, 0b00011000, 0b11111111, 0b11111111, 0b00000000, 0b00000000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00000000, 0b00000000, 0b10000000, 0b11111100, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	// i
		0b00000000, 0b10000111, 0b11001100, 0b01101000, 0b00111111, 0b01111111, 0b11100000, 0b11000000, 0b10000000, 0b00000000, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,				// ' '
		0b11111000, 0b11111100, 0b00001110, 0b00000110, 0b00111110, 0b01101110, 0b01001100, 0b01111000, 0b11110000,	0b00010000,	// o
		0b00011000, 0b11111111, 0b11111111, 0b00000000, 0100000000, 0b10000011, 0b11000110, 0b01100101, 0b00111111,	0b00000100,	// p
		0b00000000, 0b11110000, 0b11111000, 0b00001100, 0b10000100, 0b10000100, 0b11001100, 0b01111000, 0b00000000,	0b00000000,	// e
		0b11111000, 0b11110000, 0b00011000, 0b00001000, 0b00001000, 0b00011000, 0b11111000, 0b11110000, 0b00000000,	0b00000000,	// n
		0b00000000, 0b11110000, 0b11111000, 0b00001100, 0b10000100, 0b10000100, 0b11001100, 0b01111000, 0b00000000,	0b00000000,	// e
		0b11111000, 0b11111100, 0b00001100, 0b00001100, 0b00001100, 0b00011000, 0b11111111, 0b11111111, 0b00000000, 0b00000000	// d
	},
	{	/* page 3 */
		0b00000000, 0b00000000, 0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00011000, 0b00001100, // l
		0b00001100, 0b00000110, 0b00000011, 0b00011111, 0b00111111, 0b00110000, 0b00100000, 0b00110000, 0b00011000, 0b00001100, // i
		0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00011111, 0b00111111, 0b00100000, 0b00011000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00001100, 0b00000110, 0b00000011, 0b00011111, 0b00111111, 0b00110000, 0b00100000, 0b00110000, 0b00011000, 0b00001100,	// i
		0b00000111, 0b00000011, 0b00000000, 0b00011100, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00111111, 0b00011111, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,				// ' '
		0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00100000, 0b00110000, 0b00011100, 0b00000111,	0b00000000,	// o
		0b00000000, 0b11111111, 0b11111111, 0b00000001, 0b00000001, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// p
		0b00000110, 0b00001111, 0b00011111, 0b00110001, 0b00100001, 0b00100000, 0b00100000, 0b00110000, 0b00011000,	0b00001100,	// e
		0b00111111, 0b00111111, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00111111, 0b00111111, 0b00110000,	0b00011000,	// n
		0b00000110, 0b00001111, 0b00011111, 0b00110001, 0b00100001, 0b00100000, 0b00100000, 0b00110000, 0b00011000,	0b00001100,	// e
		0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00011111, 0b00111111, 0b00100000, 0b00011000	// d
	}
};

uint8_t close[4][128] = {
	{	/* page 0 */
		0b00000000, 0b00000000, 0b11110000, 0b11111000, 0b00011100, 0b00001100, 0b00001100, 0b00011000, 0b01110000, 0b11000000, // l #page 0
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,  			// ' '
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	// c
		0b00000000, 0b00000000, 0b11110000, 0b11111000, 0b00011100, 0b00001100, 0b00001100, 0b00011000, 0b01110000, 0b11000000, // l
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // o
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // e
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000	// d
	},
	{	/* page 1 */
		0b00000000, 0b00000000, 0b11111111, 0b11111111, 0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b01110000, 0b00011111, // l #page 1
		0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111110, 0b11111110, 0b00000000, 0b00000000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	// i
		0b00000000, 0b11000000, 0b01100000, 0b00100000, 0b11100000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,				// ' '
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// c
		0b00000000, 0b00000000, 0b11111111, 0b11111111, 0b00000000, 0b00000000, 0b00000000, 0b11000000, 0b01110000, 0b00011111,	// l
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// o
		0b00000000, 0b11000000, 0b01100000, 0b00100000, 0b11100000, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	// s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	0b00000000,	// e
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b11111110, 0b11111110, 0b00000000, 0b00000000	// d
	},
	{	/* page 2 */
		0b11000000, 0b01100000, 0b11111111, 0b11111111, 0b00001100, 0b00000110, 0b00000011, 0b00000001, 0b00000000, 0b00000000, // l #page 2
		0b00000000, 0b00000000, 0b10000000, 0b11111100, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, // i
		0b11111000, 0b11111100, 0b00001100, 0b00001100, 0b00001100, 0b00011000, 0b11111111, 0b11111111, 0b00000000, 0b00000000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00000000, 0b00000000, 0b10000000, 0b11111100, 0b11111100, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,	// i
		0b00000000, 0b10000111, 0b11001100, 0b01101000, 0b00111111, 0b01111111, 0b11100000, 0b11000000, 0b10000000, 0b00000000, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,				// ' '
		0b11111000, 0b11111100, 0b00000110, 0b00000010,	0b00000010, 0b01000010, 0b01100110, 0b00111100, 0b00000000, 0b00000000, // c
		0b00000000, 0b10000000, 0b11111111, 0b11111111, 0b00001100, 0b00000110, 0b00000011, 0b00000001, 0b00000000, 0b00000000,	// l
		0b11111000, 0b11111100, 0b00001110, 0b00000110, 0b00111110, 0b01101110, 0b01001100, 0b01111000, 0b11110000,	0b00010000,	// o
		0b00000000, 0b10000111, 0b11001100, 0b01101000, 0b00111111, 0b01111111, 0b11100000, 0b11000000, 0b10000000, 0b00000000,	// s
		0b00000000, 0b11110000, 0b11111000, 0b00001100, 0b10000100, 0b10000100, 0b11001100, 0b01111000, 0b00000000,	0b00000000,	// e
		0b11111000, 0b11111100, 0b00001100, 0b00001100, 0b00001100, 0b00011000, 0b11111111, 0b11111111, 0b00000000, 0b00000000	// d
	},
	{	/* page 3 */
		0b00000000, 0b00000000, 0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00011000, 0b00001100, // l #page 3
		0b00001100, 0b00000110, 0b00000011, 0b00011111, 0b00111111, 0b00110000, 0b00100000, 0b00110000, 0b00011000, 0b00001100, // i
		0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00011111, 0b00111111, 0b00100000, 0b00011000, // d
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,			 	// ' '
		0b00001100, 0b00000110, 0b00000011, 0b00011111, 0b00111111, 0b00110000, 0b00100000, 0b00110000, 0b00011000, 0b00001100,	// i
		0b00000111, 0b00000011, 0b00000000, 0b00011100, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00111111, 0b00011111, // s
		0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,				// ' '
		0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000,	0b00100000, 0b00110000, 0b00011000, 0b00001100, 0b00000110, // c
		0b00000011, 0b00000001, 0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00011000, 0b00001100,	// l
		0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00100000, 0b00110000, 0b00011100, 0b00000111,	0b00000000,	// o
		0b00000111, 0b00000011, 0b00000000, 0b00011100, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00111111, 0b00011111,	// s
		0b00000110, 0b00001111, 0b00011111, 0b00110001, 0b00100001, 0b00100000, 0b00100000, 0b00110000, 0b00011000,	0b00001100,	// e
		0b00001111, 0b00011111, 0b00110000, 0b00100000, 0b00100000, 0b00110000, 0b00011111, 0b00111111, 0b00100000, 0b00011000	// d
	}
};

void print_left_to_right()
{
	OLED_WriteCMD(0x22);  // Set page address
	OLED_WriteCMD(0x00);  // Page start = 0
	OLED_WriteCMD(0x03);  // Page end = 3

	for (int k = 0; k < COLUMN; k++)
	{
		OLED_WriteCMD(0x21);
		OLED_WriteCMD(k);
		OLED_WriteCMD(127);

		for (int i = 0; i < PAGE; i++)
		{
			for (int j = 0; j < COLUMN - k; j++)
			{
				OLED_WriteData(open[i][j]);
			}
		}
	}
}

void OLED_print_lidClose()
{
	// Set column address range (0-127) ~ 128px
	OLED_WriteCMD(0x21);  // Set column address
	OLED_WriteCMD(0x00);  // Column start = 0
	OLED_WriteCMD(0x7F);  // Column end = 127

	// Set page address range (0 - 31) ~ 32px
	OLED_WriteCMD(0x22);  // Set page address
	OLED_WriteCMD(0x00);  // Page start = 0
	OLED_WriteCMD(0x03);  // Page end = 3

	OLED_ClrScr();
	for (int i = 0; i < PAGE; i++)
	{
		for (int j = 0; j < COLUMN; j++)
		{
			OLED_WriteData(close[i][j]);
		}
	}
}

void OLED_print_lidOpen()
{
	// Set column address range (0-127) ~ 128px
	OLED_WriteCMD(0x21);  // Set column address
	OLED_WriteCMD(0x00);  // Column start = 0
	OLED_WriteCMD(0x7F);  // Column end = 127

	// Set page address range (0 - 31) ~ 32px
	OLED_WriteCMD(0x22);  // Set page address
	OLED_WriteCMD(0x00);  // Page start = 0
	OLED_WriteCMD(0x03);  // Page end = 3

	OLED_ClrScr();
	for (int i = 0; i < PAGE; i++)
	{
		for (int j = 0; j < COLUMN; j++)
		{
			OLED_WriteData(open[i][j]);
		}
	}
}

void OLED_ClrScr()
{
	// Set column address range (0-127) ~ 128px
	OLED_WriteCMD(0x21);  // Set column address
	OLED_WriteCMD(0x00);  // Column start = 0
	OLED_WriteCMD(0x7F);  // Column end = 127

    // Set page address range (0 - 31) ~ 32px
	OLED_WriteCMD(0x22);  // Set page address
	OLED_WriteCMD(0x00);  // Page start = 0
	OLED_WriteCMD(0x03);  // Page end = 3

    // Fill whole screen (4 pages x 128 columns)
    for (int page = 0; page < 4; page++)
    {
        for (int col = 0; col < 128; col++)
        {
            OLED_WriteData(0x00);
        }
    }
}

void OLED_FillWhite()
{
    // Set column address range (0-127) ~ 128px
	OLED_WriteCMD(0x21);  // Set column address
	OLED_WriteCMD(0x00);  // Column start = 0
	OLED_WriteCMD(0x7F);  // Column end = 127

    // Set page address range (0 - 31) ~ 32px
	OLED_WriteCMD(0x22);  // Set page address
	OLED_WriteCMD(0x00);  // Page start = 0
	OLED_WriteCMD(0x03);  // Page end = 3

    // Fill whole screen (4 pages x 128 columns)
    for (int page = 0; page < 4; page++)
    {
        for (int col = 0; col < 128; col++)
        {
            OLED_WriteData(0xFF);
        }
    }
}

void SSD1306_Init()
{
	HAL_Delay(100);
	OLED_WriteCMD(0xAE); //display off
	OLED_WriteCMD(0x20); //Set Memory Addressing Mode
	OLED_WriteCMD(0x00); // 00b,Horizontal Addressing Mode; 01b,Vertical Addressing Mode;
	OLED_WriteCMD(0xB0); //Set Page Start Address for Page Addressing Mode,0-7
	OLED_WriteCMD(0xC8); //Set COM Output Scan Direction
	OLED_WriteCMD(0x00); //---set low column address
	OLED_WriteCMD(0x10); //---set high column address
	OLED_WriteCMD(0x40); //--set start line address - CHECK
	OLED_WriteCMD(0xFF);
	OLED_WriteCMD(0xA1); //--set segment re-map 0 to 127 - CHECK
	OLED_WriteCMD(0xA6); //--set normal color
	OLED_WriteCMD(0xA8); //--set multiplex ratio(1 to 64) - CHECK
	OLED_WriteCMD(0x1F); //
	OLED_WriteCMD(0xA4); //0xa4,Output follows RAM content;0xa5,Output ignores RAM content
	OLED_WriteCMD(0xD3); //-set display offset - CHECK
	OLED_WriteCMD(0x00); //-not offset
	OLED_WriteCMD(0xD5); //--set display clock divide ratio/oscillator frequency
	OLED_WriteCMD(0xF0); //--set divide ratio
	OLED_WriteCMD(0xD9); //--set pre-charge period
	OLED_WriteCMD(0x22); //
	OLED_WriteCMD(0xDA); //--set com pins hardware configuration - CHECK
	OLED_WriteCMD(0x02);
	OLED_WriteCMD(0xDB); //--set vcomh
	OLED_WriteCMD(0x20); //0x20,0.77xVcc
	OLED_WriteCMD(0x8D); //--set DC-DC enable
	OLED_WriteCMD(0x14); //
	OLED_WriteCMD(0xAF); //--turn on SSD1306 panel
}

void OLED_WriteData(uint8_t data)
{
	I2C_start();
	I2C_send_addr(SSD1306_ADDR, WRITE);
	I2C_send_byte(DATA);
	I2C_send_byte(data);
	I2C_stop();
}

void OLED_WriteCMD(uint8_t cmd)
{
	I2C_start();
	I2C_send_addr(SSD1306_ADDR, WRITE);
	I2C_send_byte(CMD);
	I2C_send_byte(cmd);
	I2C_stop();
}

void I2C_send_byte(uint8_t data)
{
	uint8_t* I2C_DR = (uint8_t*) (I2C1_BASE_ADDR + 0x10);
	uint32_t* I2C_SR1 = (uint32_t*) (I2C1_BASE_ADDR + 0x14);
	*I2C_DR = data;
	while (((*I2C_SR1 >> 7) & 1) == 0);	// wait until data has been transferred
}

void I2C_stop()
{
	uint32_t* I2C_CR1 = (uint32_t*) (I2C1_BASE_ADDR + 0x00);
	*I2C_CR1 |= 1 << 9;		// send STOP
}

void I2C_send_addr(uint8_t slave_addr, mode_t mode)
{
	uint8_t* I2C_DR = (uint8_t*) (I2C1_BASE_ADDR + 0x10);
	uint32_t* I2C_SR1 = (uint32_t*) (I2C1_BASE_ADDR + 0x14);
	uint32_t* I2C_SR2 = (uint32_t*) (I2C1_BASE_ADDR + 0x18);
	/*	ADDRESS PHASE  */
	// send address to slave and select WRITE mode
	*I2C_DR = (slave_addr << 1) | mode;
	// wait until the address transmission is completed
	while (((*I2C_SR1 >> 1) & 1) == 0);
	// read SR1 and SR2 to clear ADDR bit
	volatile int tmp = *I2C_SR1;
	tmp = *I2C_SR2;
}

void I2C_start()
{
	uint32_t* I2C_CR1 = (uint32_t*) (I2C1_BASE_ADDR + 0x00);
	uint32_t* I2C_SR1 = (uint32_t*) (I2C1_BASE_ADDR + 0x14);
	// send START
	*I2C_CR1 |= 1 << 8;
	// wait until START condition is generated and operate at Master mode
	while ((*I2C_SR1 & 1) == 0);
}

/*
 * This function is used to initialize I2C1 peripheral
 * PB6: SCL
 * PB7: SDA
 */
void I2C_Init()
{
	__HAL_RCC_GPIOB_CLK_ENABLE();
	uint32_t* GPIOB_MODER = (uint32_t*) (GPIOB_BASE_ADDR + 0x00);
	uint32_t* GPIOB_OTYPER = (uint32_t*) (GPIOB_BASE_ADDR + 0x04);
	uint32_t* GPIOB_PUPDR = (uint32_t*) (GPIOB_BASE_ADDR + 0x0C);
	uint32_t* GPIOB_AFRL = (uint32_t*) (GPIOB_BASE_ADDR + 0x20);
	*GPIOB_MODER &= ~(0xf << 12);	// clear bit
	*GPIOB_MODER |= (0b1010 << 12);	// set PB6, PB7 at AF mode
	*GPIOB_OTYPER |= (0b11 << 6);	// set open-drain mode
	*GPIOB_PUPDR &= ~(0xf << 12);	// clear bit
	*GPIOB_PUPDR |= (0b0101 << 12);	// configure PB6, PB7 the I/O pull-up
	*GPIOB_AFRL &= ~(0xff << 24);	// clear bit
	*GPIOB_AFRL |= (4 << 24) | (4 << 28);	// select AF04

	__HAL_RCC_I2C1_CLK_ENABLE();
	uint32_t* I2C_CR2 = (uint32_t*) (I2C1_BASE_ADDR + 0x04);
	uint32_t* I2C_CCR = (uint32_t*) (I2C1_BASE_ADDR + 0x1C);
	uint32_t* I2C_TRISE = (uint32_t*) (I2C1_BASE_ADDR + 0x20);
	uint32_t* I2C_CR1 = (uint32_t*) (I2C1_BASE_ADDR + 0x00);
	*I2C_CR2 |= (16 << 0);	// set f = 16MHz
	*I2C_CCR &= ~(1 << 15);	// select standard mode
	*I2C_CCR |= 80 << 0; 	// set SCL freq = 100 kHz
	*I2C_TRISE = 17; 		// set time rise
	*I2C_CR1 |= (1 << 0);	// enable peripheral
}
